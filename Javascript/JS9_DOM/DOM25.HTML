<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <form>
        <label for="id">id</label>
        <input type="text" id="id"><br>

        <label for="fname">fname</label>
        <input type="text" name="" id="fname"><br>

        <label for="lname">lname</label>
        <input type="text" id="lname"><br>

        <label for="email">email</label>
        <input type="text" id="email"><br>
        

        <label for="gender">gender</label>
        <input type="radio" name="gender" value="male">
        <label for="male">male</label>,<br>
        <input type="radio" name="gender" value="female">
        <label for="female">Female</label><br>
        <input type="radio" name="gender" value="others">
        <label for="others">Others</label><br>

        <label for="subjects">subjects</label>
        <input type="checkbox" name="subjects" value="Html">
        <label>Html</label><br>
        <input type="checkbox" name="subjects" value="Css">
        <label>Css</label><br>
        <input type="checkbox" name="subjects" value="Javascript">
        <label>Javascript</label><br>
        <input type="checkbox" name="subjects" value="ReactJs">
        <label>ReactJs</label><br>

        <label for="date">date</label>
        <input type="date" name="date" id="dob"><br>

        <input type="button" id="addUserBtn" value="submit" onclick="addUser()">
        <input type="button" id="updateUserBtn" value="updateUser" onclick="updateUser()">
    </form>
    <table border="1">
        <tr>
            <th>id</th>
            <th>fname</th>
            <th>lname</th>
            <th>email</th>
           
            <th>gender</th>
            <th>subjects</th>
            <th>dob</th>

            <th>Edit</th>
            <th>Delete</th>
        </tr>
        <tbody>

        </tbody>
    </table>
    <script>
        function addUser() {
            var user = {
                id: document.getElementById("id").value,
                fname: document.getElementById("fname").value,
                lname: document.getElementById("lname").value,
                email: document.getElementById("email").value,
                dob: document.getElementById("dob").value,
                subjects: [],
                gender: null

            }
            var allRadioBtns = document.getElementsByName("gender")
            for (var i = 0; i < allRadioBtns.length; i++) {
                if (allRadioBtns[i].checked) {
                    user.gender = allRadioBtns[i].value
                }
            }
            var allCheckBoxes = document.getElementsByName("subjects")
            for (var i = 0; i < allCheckBoxes.length; i++) {
                if (allCheckBoxes[i].checked) {
                    user.subjects = allCheckBoxes[i].value
                }
            }
            console.log("add user called", user)
            addUserToApi(user)
        }
        function addUserToApi(user) {
            var sendData = new XMLHttpRequest();
            sendData.onreadystatechange = function () {
                if (sendData.status == 200 && sendData.onreadystate == 4) 
                    console.log(JSON.parse(sendData.responseText))
                
            }
            sendData.send("POST"," http://localhost:3000/users") 
            sendData.setRequestHeader("content-type","Applcation/json")
            sendData.send(JSON.stringify(user))

        }
        // Read user
        var users = []
        function getUsersFromApi() {
            var getData = new XMLHttpRequest();
            getData.onreadystatechange = function () {
                if (getData.status == 200 && getData.readyState == 4) {
                    console.log(JSON.parse(getData.responseText));
                    users = JSON.parse(getData.responseText);
                    displayUsers()

                }
            }
            getData.open("GET", " http://localhost:3000/users");
            getData.send()
        }
        getUsersFromApi()
        function displayUsers(){
            console.log(users)
            for (var i = 0; i < users.length; i++) {
                var myTr = document.createElement("tr")
                var eachObj = users[i]

                for (a in eachObj) {
                    var myTd = document.createElement("td");
                    myTd.innerHTML = eachObj[a]
                    myTr.appendChild(myTd)
                }

                var editTd = document.createElement("td");
               var editBtn = document.createElement("button");
                editBtn.innerHTML = "Edit";
                editTd.appendChild(editBtn);
                myTr.appendChild(editTd);
                editBtn.setAttribute("onclick", "editUser(" + i + ")")

                var delTd = document.createElement("td");
                var delBtn = document.createElement("button");
                delBtn.innerHTML = "Delete";
                delTd.appendChild(delBtn);
                myTr.appendChild(delTd);
                delBtn.setAttribute("onclick", "deleteUser(" + i + ")")


                document.querySelector("tbody").appendChild(myTr)
            }
        }

        var gIndex = null;
        function editUser(i) {
            console.log(users[i]);
            gIndex = i
            document.getElementById("id").value = users[i].id
            document.getElementById("fname").value = users[i].fname;
            document.getElementById("email").value = users[i].email;
            document.getElementById("dob").value = users[i].dob;
            document.getElementById("state").value = users[i].state;

            var allRadioBtns = document.getElementsByName("gender");
            for (let index = 0; index < allRadioBtns.length; index++) {
                if (allRadioBtns[index].value === users[i].gender) {
                    allRadioBtns[index].checked = true;
                }
            }
            var allCheckBoxes = document.getElementsByName("subjects");
            for (let index = 0; index < allCheckBoxes.length; index++) {
                //    console.log(allCheckBoxes[index])
                //     console.log( users[i].subjects)

                var check = users[i].subjects.some((val) => allCheckBoxes[index].value === val);
                allCheckBoxes[index].checked = check

        }
    }
            function updateUser() {
            var user = {
                id: document.getElementById("id").value,
                fname: document.getElementById("fname").value,
                fname: document.getElementById("lname").value,

                email: document.getElementById("email").value,
               
                dob: document.getElementById("dob").value,
                subjects: [],
                gender: null
            }

            var allRadioBtns = document.getElementsByName("gender");
            for (i = 0; i < allRadioBtns.length; i++) {
                if (allRadioBtns[i].checked) {
                    user.gender = allRadioBtns[i].value
                }
            }

            var allCheckBoxes = document.getElementsByName("subjects")
            for (let i = 0; i < allCheckBoxes.length; i++) {
                if (allCheckBoxes[i].checked) {
                    user['subjects'].push(allCheckBoxes[i].value)
                }

            }
            updateUserToApi(user)
        }

        function updateUserToApi(user) {
            var postData = new XMLHttpRequest();
            postData.onreadystatechange = function () {
                if (postData.status == 200 && postData.readyState == 4) {
                    console.log("User Added", JSON.parse(postData.response))
                }
            }
            postData.open("PUT", " http://localhost:3000/users/" + users[gIndex].id);
            postData.setRequestHeader("content-type", "application/json");
            postData.send(JSON.stringify(user))
        }
        // Delete user

        function deleteUser(i) {
            console.log(users[i])

            var deleteData = new XMLHttpRequest();
            deleteData.onreadystatechange = function () {
                if (deleteData.status == 200 && deleteData.readyState == 4) {
                    users = JSON.parse(deleteData.response);
                    displayUsers()
                }
            }
            deleteData.open("DELETE", " http://localhost:3000/users" + users[i].id);
            deleteData.send()
        }
   
    </script>
</body>

</html>